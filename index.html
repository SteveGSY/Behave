<!DOCTYPE html>
<html lang="en" class="bg-slate-100 dark:bg-slate-900">
<head>
  <meta charset="UTF-8">
  <title>Home Behaviour Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <base href="/Behave/">

  <!-- PWA -->
  <link rel="manifest" href="/Behave/manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="/Behave/icon-192.png">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    (() => {
      const stored = localStorage.getItem("hb-theme");
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      if (stored === "dark" || (!stored && prefersDark)) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    })();
  </script>

  <style>
    body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      padding-bottom: 100px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top left,
        #ff9a9e 0, #fad0c4 30%, #a1c4fd 70%, #c2e9fb 100%);
    }
    .dark body {
      background: radial-gradient(circle at top left,
        #0f172a 0, #020617 40%, #1e293b 80%, #020617 100%);
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.22);
      border-radius: 22px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.25);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .dark .glass-card {
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(148, 163, 184, 0.6);
    }
    .glass-bar {
      background: rgba(255, 255, 255, 0.18);
      border-radius: 26px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    .dark .glass-bar {
      background: rgba(15, 23, 42, 0.8);
      border-color: rgba(148, 163, 184, 0.7);
    }
    .fade-page {
      transition: opacity 0.25s ease, transform 0.25s ease;
    }
    .fade-page.hidden {
      opacity: 0;
      transform: translateX(10px);
      pointer-events: none;
    }
    .fade-page.active {
      opacity: 1;
      transform: translateX(0);
    }

    .score-pop { animation: popScore 0.35s ease-out; }
    @keyframes popScore {
      0% { transform: scale(1); }
      30% { transform: scale(1.25); }
      60% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }
    .score-shake { animation: shakeScore 0.45s ease-in-out; }
    @keyframes shakeScore {
      0% { transform: translateX(0); }
      20% { transform: translateX(-6px); }
      40% { transform: translateX(6px); }
      60% { transform: translateX(-4px); }
      80% { transform: translateX(4px); }
      100% { transform: translateX(0); }
    }
    .flash-green { animation: flashGreen 0.45s ease-out; }
    .flash-red { animation: flashRed 0.45s ease-out; }
    @keyframes flashGreen {
      0% { background-color: rgba(34,197,94,0.6); }
      100% { background-color: transparent; }
    }
    @keyframes flashRed {
      0% { background-color: rgba(239,68,68,0.6); }
      100% { background-color: transparent; }
    }

    .floating-nav {
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
      z-index: 50;
    }
    .floating-btn {
      width: 56px;
      height: 56px;
      border-radius: 9999px;
      background: rgba(255, 255, 255, 0.22);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.35);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    .floating-btn:active {
      transform: scale(0.94);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.4);
    }
    .floating-btn-active {
      background: rgba(59,130,246,0.25);
      border-color: rgba(59,130,246,0.9);
    }

    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: none;
      z-index: 40;
    }
    .sheet-backdrop.active {
      display: block;
    }
    .sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: -100%;
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 -18px 45px rgba(15, 23, 42, 0.35);
      padding: 16px 16px 24px;
      max-height: 70vh;
      overflow-y: auto;
      transition: transform 0.25s ease, bottom 0.25s ease;
      z-index: 50;
    }
    .dark .sheet {
      background: rgba(15, 23, 42, 0.96);
    }
    .sheet.active {
      bottom: 0;
    }

    @media (prefers-reduced-motion: reduce) {
      .fade-page,
      .score-pop,
      .score-shake {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
</head>

<body class="text-slate-900 dark:text-slate-100">
  <div class="app-shell px-3 sm:px-4">
    <div class="w-full max-w-xl mx-auto flex flex-col gap-4 sm:gap-6 h-full">

      <header class="glass-bar px-4 py-3 flex items-center justify-between mt-3 sm:mt-4">
        <div class="flex items-center gap-2">
          <span id="backFromCharts"
                class="hidden text-sm text-blue-500 font-semibold cursor-pointer select-none">
            ‚Äπ Tracker
          </span>
        </div>
        <div class="text-center flex-1">
          <h1 class="text-lg sm:text-xl font-semibold">Home Behaviour</h1>
        </div>
        <div class="flex items-center gap-2">
          <button id="darkModeToggle"
                  class="text-xs sm:text-sm px-3 py-1.5 rounded-full bg-white/70 dark:bg-slate-800/80 text-slate-800 dark:text-slate-100 shadow-sm active:scale-95 transition">
            Dark
          </button>
          <button id="fullscreenBtn"
                  class="text-xs sm:text-sm px-3 py-1.5 rounded-full bg-white/70 dark:bg-slate-800/80 text-slate-800 dark:text-slate-100 shadow-sm active:scale-95 transition">
            Fullscreen
          </button>
        </div>
      </header>

      <main id="mainContainer"
            class="glass-card flex-1 p-4 sm:p-6 flex flex-col overflow-hidden max-w-full">

        <!-- TRACKER PAGE -->
        <div id="trackerPage" class="fade-page active flex flex-col gap-4 sm:gap-6 h-full">

          <div class="flex gap-2 w-full text-center">
            <div class="glass-card flex-1 p-2 sm:p-3 shadow-sm">
              <p class="text-[10px] sm:text-xs text-slate-600 dark:text-slate-300">Today</p>
              <p id="todayScore" class="text-xl sm:text-2xl font-semibold">0</p>
            </div>
            <div class="glass-card flex-1 p-2 sm:p-3 shadow-sm">
              <p class="text-[10px] sm:text-xs text-slate-600 dark:text-slate-300">This Week</p>
              <p id="weekScore" class="text-xl sm:text-2xl font-semibold">0</p>
            </div>
            <div class="glass-card flex-1 p-2 sm:p-3 shadow-sm">
              <p class="text-[10px] sm:text-xs text-slate-600 dark:text-slate-300">Total</p>
              <p id="totalScore" class="text-xl sm:text-2xl font-semibold">0</p>
            </div>
          </div>

          <section class="glass-card p-3 sm:p-4 flex flex-col gap-2">
            <h2 class="text-sm sm:text-base font-semibold">Streaks & Achievements</h2>
            <div class="grid grid-cols-3 gap-2 text-center text-xs sm:text-sm">
              <div>
                <p class="text-slate-500 dark:text-slate-300">Current Streak</p>
                <p id="currentStreak" class="text-lg font-semibold">0</p>
              </div>
              <div>
                <p class="text-slate-500 dark:text-slate-300">Best Streak</p>
                <p id="bestStreak" class="text-lg font-semibold">0</p>
              </div>
              <div>
                <p class="text-slate-500 dark:text-slate-300">Positive Days</p>
                <p id="positiveDays" class="text-lg font-semibold">0</p>
              </div>
            </div>
            <div id="achievements"
                 class="mt-2 text-xs sm:text-sm text-slate-700 dark:text-slate-200"></div>
          </section>

          <section class="glass-card p-4 sm:p-5 flex-1 flex flex-col min-h-0">
            <div class="flex items-center justify-between mb-2">
              <h2 class="text-base sm:text-lg font-semibold">Recent Events</h2>
              <div class="flex gap-2">
                <button id="exportBtn"
                        class="bg-emerald-500/90 text-white px-3 py-1.5 rounded-full text-xs sm:text-sm shadow active:scale-95 transition">
                  Export CSV
                </button>
                <label
                  class="bg-slate-700/90 text-white px-3 py-1.5 rounded-full text-xs sm:text-sm shadow cursor-pointer active:scale-95 transition">
                  Import
                  <input id="importInput" type="file" accept=".csv" class="hidden">
                </label>
              </div>
            </div>

            <div class="overflow-x-auto rounded-2xl border border-white/40 bg-white/40 dark:bg-slate-800/60 flex-1 min-h-0 w-full">
              <table class="w-full border-collapse text-sm">
                <thead class="bg-white/70 dark:bg-slate-900/70">
                  <tr class="text-left text-slate-700 dark:text-slate-200">
                    <th class="p-2">Time</th>
                    <th class="p-2">Type</th>
                    <th class="p-2">Category</th>
                    <th class="p-2">Points</th>
                    <th class="p-2">Notes</th>
                    <th class="p-2">Delete</th>
                  </tr>
                </thead>
                <tbody id="eventsTableBody" class="bg-white/40 dark:bg-slate-900/40"></tbody>
              </table>
            </div>
          </section>

        </div>

        <!-- CHARTS PAGE -->
        <div id="chartsPage" class="fade-page hidden flex-col gap-4 sm:gap-5 h-full">
          <div class="flex justify-between items-center">
            <h2 class="text-base sm:text-lg font-semibold">Charts & Analytics</h2>
            <span class="text-xs sm:text-sm text-slate-600 dark:text-slate-300">
              Based on all saved events
            </span>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-5 flex-1 min-h-0">
            <div class="glass-card p-3 sm:p-4 flex flex-col">
              <h3 class="font-semibold mb-2 text-sm sm:text-base">Points This Week</h3>
              <canvas id="weeklyChart" class="flex-1" height="120"></canvas>
            </div>

            <div class="glass-card p-3 sm:p-4 flex flex-col">
              <h3 class="font-semibold mb-2 text-sm sm:text-base">Points Today</h3>
              <canvas id="dailyChart" class="flex-1" height="120"></canvas>
            </div>

            <div class="glass-card p-3 sm:p-4 flex flex-col">
              <h3 class="font-semibold mb-2 text-sm sm:text-base">Points This Month</h3>
              <canvas id="monthlyChart" class="flex-1" height="120"></canvas>
            </div>

            <div class="glass-card p-3 sm:p-4 flex flex-col">
              <h3 class="font-semibold mb-2 text-sm sm:text-base">Points by Category</h3>
              <canvas id="categoryChart" class="flex-1" height="120"></canvas>
            </div>
          </div>
        </div>

        <!-- WEEKLY REPORT PAGE -->
        <div id="reportPage" class="fade-page hidden flex-col gap-4 sm:gap-5 h-full">
          <h2 class="text-base sm:text-lg font-semibold">Weekly Report</h2>

          <section class="glass-card p-4 sm:p-5 flex flex-col gap-3">
            <h3 class="font-semibold text-sm sm:text-base">Summary</h3>
            <div id="weeklySummary" class="text-sm sm:text-base"></div>
          </section>

          <section class="glass-card p-4 sm:p-5 flex flex-col gap-3">
            <h3 class="font-semibold text-sm sm:text-base">Category Breakdown</h3>
            <div id="weeklyCategoryBreakdown" class="text-sm sm:text-base"></div>
          </section>

          <section class="glass-card p-4 sm:p-5 flex flex-col gap-3">
            <h3 class="font-semibold text-sm sm:text-base">Achievements</h3>
            <div id="weeklyAchievements" class="text-sm sm:text-base"></div>
          </section>

          <section class="glass-card p-4 sm:p-5 flex flex-col gap-3">
            <h3 class="font-semibold text-sm sm:text-base">Shareable Summary</h3>
            <textarea id="weeklyShareText"
                      class="w-full p-3 rounded-lg bg-white/60 dark:bg-slate-800/80 text-sm"
                      rows="5"></textarea>
          </section>
        </div>

      </main>
    </div>
  </div>

  <div class="floating-nav">
    <button id="tabTracker" class="floating-btn floating-btn-active" title="Tracker">
      <span>üîµ</span>
    </button>
    <button id="addBehaviourFab" class="floating-btn" title="Add Behaviour">
      <span>‚ûï</span>
    </button>
    <button id="tabCharts" class="floating-btn" title="Charts">
      <span>üìä</span>
    </button>
    <button id="tabReport" class="floating-btn" title="Weekly Report">
      <span>üìù</span>
    </button>
  </div>

  <div id="sheetBackdrop" class="sheet-backdrop"></div>
  <div id="addSheet" class="sheet">
    <div class="w-12 h-1.5 bg-slate-300 dark:bg-slate-600 rounded-full mx-auto mb-3"></div>
    <h2 class="text-base sm:text-lg font-semibold mb-3">Add Behaviour</h2>

    <form id="eventForm" class="space-y-3 sm:space-y-4">
      <div>
        <label class="block text-xs sm:text-sm font-medium mb-1">Behaviour Type</label>
        <div class="flex flex-wrap gap-4">
          <label class="flex items-center gap-1 text-sm">
            <input type="radio" name="type" value="positive" checked>
            <span>Positive</span>
          </label>
          <label class="flex items-center gap-1 text-sm">
            <input type="radio" name="type" value="negative">
            <span>Negative</span>
          </label>
        </div>
      </div>

      <div>
        <label for="category" class="block text-xs sm:text-sm font-medium mb-1">Category</label>
        <select id="category"
                class="border border-white/60 bg-white/60 dark:bg-slate-800/80 dark:border-slate-600 rounded-full px-3 py-2 w-full sm:w-auto sm:min-w-[150px] text-sm shadow-inner">
          <option>Helping</option>
          <option>Homework</option>
          <option>Kindness</option>
          <option>Not listening</option>
          <option>Rudeness</option>
        </select>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label for="points" class="block text-xs sm:text-sm font-medium mb-1">Points</label>
          <input id="points" type="number" value="1"
                 class="border border-white/60 bg-white/60 dark:bg-slate-800/80 dark:border-slate-600 rounded-full px-3 py-2 w-full text-sm shadow-inner">
        </div>

        <div>
          <label for="notes" class="block text-xs sm:text-sm font-medium mb-1">Notes</label>
          <input id="notes" type="text" placeholder="Notes (optional)"
                 class="border border-white/60 bg-white/60 dark:bg-slate-800/80 dark:border-slate-600 rounded-full px-3 py-2 w-full text-sm shadow-inner">
        </div>
      </div>

      <div class="flex flex-wrap gap-2 text-xs sm:text-sm">
        <button type="button" data-quick="positive:Kindness:1"
                class="px-3 py-1.5 rounded-full bg-emerald-500/90 text-white shadow">
          +1 Kindness
        </button>
        <button type="button" data-quick="positive:Homework:1"
                class="px-3 py-1.5 rounded-full bg-sky-500/90 text-white shadow">
          +1 Homework
        </button>
        <button type="button" data-quick="negative:Rudeness:1"
                class="px-3 py-1.5 rounded-full bg-rose-500/90 text-white shadow">
          -1 Rudeness
        </button>
      </div>

      <button
        class="mt-1 bg-blue-600 text-white px-4 py-2.5 rounded-full w-full text-sm sm:text-base font-medium shadow-md active:scale-95 transition">
        Add Behaviour
      </button>
    </form>
  </div>

  <div id="updateBanner"
       class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg hidden text-sm cursor-pointer z-50">
    New version available ‚Äî tap to refresh
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    import { initStorage } from "/Behave/js/storage.js";
    import { initEvents } from "/Behave/js/events.js";
    import { initCharts } from "/Behave/js/charts.js";
    import { initUI } from "/Behave/js/ui.js";
    import { initGestures } from "/Behave/js/gestures.js";
    import { initPWA } from "/Behave/js/pwa.js";

    document.addEventListener("DOMContentLoaded", async () => {
      const state = await initStorage();
      const api = initEvents(state);
      initCharts(state, api);
      initUI(state, api);
      initGestures(state, api);
      initPWA(state, api);
    });
  </script>
</body>
</html>
